<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Food Ordering App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Supabase configuration
    const supabase = Supabase.createClient(
      'https://dlnenwglsmfyhdysmqdc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsbmVud2dsc21meWhkeXNtcWRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTM5ODIsImV4cCI6MjA3MTY4OTk4Mn0.oWKClbQFN5RDS_MkFkPFbwel-LBmD8iGJX1KxN3Db0U'
    );

    const whatsappNumbers = [
      '+6281234567890',
      '+6280987654321',
      '+6281122334455',
      '+6285566778899'
    ];

    const App = () => {
      const [products, setProducts] = useState([]);
      const [filteredProducts, setFilteredProducts] = useState([]);
      const [categories, setCategories] = useState([]);
      const [selectedCategory, setSelectedCategory] = useState('all');
      const [searchQuery, setSearchQuery] = useState('');
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [quantity, setQuantity] = useState(1);
      const [showProductModal, setShowProductModal] = useState(false);
      const [showCheckoutModal, setShowCheckoutModal] = useState(false);
      const [checkoutData, setCheckoutData] = useState({
        fullName: '',
        address: '',
        rt: '',
        rw: '',
        whatsapp: '',
        notes: ''
      });

      // Fetch products from Supabase
      useEffect(() => {
        const fetchProducts = async () => {
          const { data, error } = await supabase.from('products').select('*');
          if (error) {
            console.error('Error fetching products:', error);
            return;
          }
          setProducts(data);
          setFilteredProducts(data);
          const uniqueCategories = ['all', ...new Set(data.map(p => p.category))];
          setCategories(uniqueCategories);
        };
        fetchProducts();
      }, []);

      // Handle search and filter
      useEffect(() => {
        let filtered = products;
        if (selectedCategory !== 'all') {
          filtered = filtered.filter(p => p.category === selectedCategory);
        }
        if (searchQuery) {
          filtered = filtered.filter(p =>
            p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            p.description.toLowerCase().includes(searchQuery.toLowerCase())
          );
        }
        setFilteredProducts(filtered);
      }, [selectedCategory, searchQuery, products]);

      const openProductModal = (product) => {
        setSelectedProduct(product);
        setQuantity(1);
        setShowProductModal(true);
      };

      const handleCheckout = () => {
        setShowProductModal(false);
        setShowCheckoutModal(true);
      };

      const handleCheckoutSubmit = () => {
        const randomOperator = whatsappNumbers[Math.floor(Math.random() * whatsappNumbers.length)];
        const message = `New Order:
        Product: ${selectedProduct.name}
        Quantity: ${quantity}
        Total: Rp${(selectedProduct.price * quantity).toLocaleString()}
        Name: ${checkoutData.fullName}
        Address: ${checkoutData.address}, RT ${checkoutData.rt}, RW ${checkoutData.rw}
        WhatsApp: ${checkoutData.whatsapp}
        Notes: ${checkoutData.notes || '-'}`;
        
        const whatsappUrl = `https://wa.me/${randomOperator}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
        setShowCheckoutModal(false);
        setCheckoutData({
          fullName: '',
          address: '',
          rt: '',
          rw: '',
          whatsapp: '',
          notes: ''
        });
      };

      return (
        <div className="min-h-screen bg-gray-100">
          {/* Header */}
          <header className="bg-white shadow">
            <div className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
              <h1 className="text-3xl font-bold text-gray-900">Food Ordering App</h1>
            </div>
          </header>

          {/* Search and Category Filter */}
          <div className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <div className="flex flex-col sm:flex-row gap-4 mb-6">
              <input
                type="text"
                placeholder="Search products..."
                className="flex-1 p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
              <select
                className="p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                value={selectedCategory}
                onChange={(e) => setSelectedCategory(e.target.value)}
              >
                {categories.map(category => (
                  <option key={category} value={category}>{category.charAt(0).toUpperCase() + category.slice(1)}</option>
                ))}
              </select>
            </div>

            {/* Slider */}
            <div className="relative mb-6">
              <div className="overflow-x-auto flex gap-4 pb-4">
                {categories.map(category => (
                  <button
                    key={category}
                    className={`px-4 py-2 rounded-full ${selectedCategory === category ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'}`}
                    onClick={() => setSelectedCategory(category)}
                  >
                    {category.charAt(0).toUpperCase() + category.slice(1)}
                  </button>
                ))}
              </div>
            </div>

            {/* Product Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {filteredProducts.map(product => (
                <div
                  key={product.id}
                  className="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer"
                  onClick={() => openProductModal(product)}
                >
                  <img src={product.image_url} alt={product.name} className="w-full h-48 object-cover" />
                  <div className="p-4">
                    <h3 className="text-lg font-semibold">{product.name}</h3>
                    <p className="text-gray-600">Rp{product.price.toLocaleString()}</p>
                    <p className="text-gray-500 text-sm mt-1">{product.description}</p>
                    <p className="text-gray-500 text-sm mt-1">Location: {product.location}</p>
                    <p className="text-gray-500 text-sm">Merchant: {product.merchant_name}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Product Modal */}
          {showProductModal && selectedProduct && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 max-w-lg w-full">
                <h2 className="text-2xl font-bold mb-4">{selectedProduct.name}</h2>
                <img src={selectedProduct.image_url} alt={selectedProduct.name} className="w-full h-64 object-cover mb-4" />
                <p className="text-gray-600 mb-2">Rp{selectedProduct.price.toLocaleString()}</p>
                <p className="text-gray-500 mb-2">{selectedProduct.description}</p>
                <p className="text-gray-500 mb-2">Location: {selectedProduct.location}</p>
                <p className="text-gray-500 mb-4">Merchant: {selectedProduct.merchant_name}</p>
                <div className="flex items-center mb-4">
                  <button
                    className="px-3 py-1 bg-gray-200 rounded-l-md"
                    onClick={() => setQuantity(q => Math.max(1, q - 1))}
                  >
                    -
                  </button>
                  <span className="px-4 py-1 bg-gray-100">{quantity}</span>
                  <button
                    className="px-3 py-1 bg-gray-200 rounded-r-md"
                    onClick={() => setQuantity(q => q + 1)}
                  >
                    +
                  </button>
                </div>
                <div className="flex gap-4">
                  <button
                    className="flex-1 bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600"
                    onClick={handleCheckout}
                  >
                    Buy Now
                  </button>
                  <button
                    className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400"
                    onClick={() => setShowProductModal(false)}
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Checkout Modal */}
          {showCheckoutModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 max-w-lg w-full">
                <h2 className="text-2xl font-bold mb-4">Checkout</h2>
                <div className="space-y-4">
                  <input
                    type="text"
                    placeholder="Full Name"
                    className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={checkoutData.fullName}
                    onChange={(e) => setCheckoutData({ ...checkoutData, fullName: e.target.value })}
                  />
                  <input
                    type="text"
                    placeholder="Address"
                    className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={checkoutData.address}
                    onChange={(e) => setCheckoutData({ ...checkoutData, address: e.target.value })}
                  />
                  <div className="flex gap-4">
                    <input
                      type="text"
                      placeholder="RT"
                      className="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={checkoutData.rt}
                      onChange={(e) => setCheckoutData({ ...checkoutData, rt: e.target.value })}
                    />
                    <input
                      type="text"
                      placeholder="RW"
                      className="w-1/2 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={checkoutData.rw}
                      onChange={(e) => setCheckoutData({ ...checkoutData, rw: e.target.value })}
                    />
                  </div>
                  <input
                    type="text"
                    placeholder="WhatsApp Number"
                    className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={checkoutData.whatsapp}
                    onChange={(e) => setCheckoutData({ ...checkoutData, whatsapp: e.target.value })}
                  />
                  <textarea
                    placeholder="Order Notes"
                    className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={checkoutData.notes}
                    onChange={(e) => setCheckoutData({ ...checkoutData, notes: e.target.value })}
                  />
                </div>
                <div className="flex gap-4 mt-6">
                  <button
                    className="flex-1 bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600"
                    onClick={handleCheckoutSubmit}
                  >
                    Process Order
                  </button>
                  <button
                    className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400"
                    onClick={() => setShowCheckoutModal(false)}
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
