<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Home Pemesanan Makanan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#fff8f2',
              100: '#ffefe0',
              500: '#ff6a00',
              700: '#e05500'
            }
          }
        }
      }
    }
  </script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.16.0/dist/umd/supabase.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Header / Navbar -->
  <header class="bg-white shadow sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center gap-4">
          <img id="main-logo" src="LOGO_SRC" alt="logo" class="h-10 w-10 object-contain"/>
          <div>
            <h1 class="text-lg font-semibold">Nama App</h1>
            <p class="text-xs text-gray-500">Pesan makanan cepat</p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <div class="relative">
            <input id="search" type="search" placeholder="Cari makanan atau merchant..." 
              class="w-72 px-4 py-2 rounded-md border border-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-brand-500"/>
            <button id="clear-search" class="absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 hidden">✕</button>
          </div>

          <nav class="hidden md:flex gap-3 items-center">
            <button id="btn-categories" class="px-3 py-2 rounded-md text-sm bg-white border border-gray-200">Kategori</button>
            <button id="btn-wishlist" class="px-3 py-2 rounded-md text-sm bg-white border border-gray-200">Wishlist</button>
          </nav>

          <button id="mobile-menu-btn" class="md:hidden px-3 py-2 bg-white border rounded-md">Menu</button>
        </div>
      </div>
    </div>

    <!-- Category strip -->
    <div class="bg-white border-t border-b">
      <div class="max-w-7xl mx-auto px-4 py-3 flex gap-3 overflow-x-auto">
        <button class="category-chip px-3 py-1 rounded-full bg-brand-50 text-sm">Semua</button>
      </div>
    </div>
  </header>

  <!-- Hero / Slider -->
  <section class="max-w-7xl mx-auto px-4 py-6">
    <div id="hero-slider" class="relative rounded-lg overflow-hidden h-48 bg-gray-100">
      <div class="absolute inset-0 flex items-center justify-between px-4">
        <button id="hero-prev" class="bg-white/80 rounded-full p-2 shadow">‹</button>
        <button id="hero-next" class="bg-white/80 rounded-full p-2 shadow">›</button>
      </div>
      <div id="hero-content" class="h-full flex items-center justify-center text-center px-6">
        <div>
          <h2 class="text-2xl font-bold">Promo Hari Ini</h2>
          <p class="text-sm text-gray-600">Slide untuk melihat merchant unggulan</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content: product grid -->
  <main class="max-w-7xl mx-auto px-4 pb-20">
    <div class="mt-6 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4" id="product-grid">
      <!-- cards injected here -->
    </div>
  </main>

  <!-- Product Modal -->
  <div id="product-modal" class="fixed inset-0 hidden z-30 items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-xl w-full max-w-2xl shadow-lg overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="modal-title" class="font-semibold text-lg">Produk</h3>
        <button id="modal-close" class="text-gray-500">✕</button>
      </div>
      <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <div class="relative h-60 bg-gray-100 rounded overflow-hidden" id="modal-image-wrap">
            <img id="modal-image" src="" alt="foto" class="w-full h-full object-cover"/>
            <div class="absolute left-2 top-2 flex gap-2">
              <button id="img-prev" class="bg-white/90 rounded-full p-1">‹</button>
              <button id="img-next" class="bg-white/90 rounded-full p-1">›</button>
            </div>
          </div>
        </div>

        <div>
          <p id="modal-merchant" class="text-sm text-gray-500"></p>
          <h4 id="modal-name" class="text-xl font-bold mt-1"></h4>
          <p id="modal-desc" class="text-sm text-gray-600 mt-2"></p>

          <div class="mt-4 flex items-center justify-between">
            <div>
              <div class="text-xs text-gray-500">Harga</div>
              <div id="modal-price" class="text-2xl font-semibold text-brand-700"></div>
            </div>
            <div>
              <button id="btn-wishlist-toggle" class="px-3 py-2 rounded-md border">♡ Wishlist</button>
            </div>
          </div>

          <div class="mt-6">
            <button id="btn-order" class="w-full px-4 py-3 rounded-md bg-brand-500 text-white font-medium">Pesan</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkout-modal" class="fixed inset-0 hidden z-40 items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-xl w-full max-w-md shadow-lg overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="font-semibold">Form Checkout</h3>
        <button id="checkout-close" class="text-gray-500">✕</button>
      </div>
      <form id="checkout-form" class="p-4 space-y-3">
        <div>
          <label class="text-sm text-gray-600">Nama Lengkap</label>
          <input name="full_name" required class="w-full px-3 py-2 border rounded-md"/>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-gray-600">RT</label>
            <input name="rt" required class="w-full px-3 py-2 border rounded-md"/>
          </div>
          <div>
            <label class="text-sm text-gray-600">RW</label>
            <input name="rw" required class="w-full px-3 py-2 border rounded-md"/>
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-600">Nomor HP (aktif)</label>
          <input name="phone" required class="w-full px-3 py-2 border rounded-md" placeholder="08xxxxxxxx"/>
        </div>

        <div class="pt-2">
          <button type="submit" class="w-full px-4 py-3 rounded-md bg-brand-500 text-white font-medium">Konfirmasi & Kirim ke WhatsApp</button>
        </div>
      </form>
    </div>
  </div>

<script>
/* =================== CONFIG =================== */
/* Ganti nilai ini dengan kredensial Supabase Anda */
const SUPABASE_URL = 'https://SUPABASE_URL';
const SUPABASE_ANON_KEY = 'SUPABASE_ANON_KEY';
const LOGO_SRC = 'LOGO_SRC'; // optional overwrite
/* nama tabel produk dan pesan.
   disarankan tabel produk: 'produk' (kolom: id, name, description, price, images (array), merchant_name, merchant_address, category)
   tabel message: 'message' atau 'messages' dengan kolom 'wa_number' (string) */
const TABLE_PRODUCTS = 'produk';
const TABLE_MESSAGES = 'message';
/* ============================================ */

if (LOGO_SRC !== 'LOGO_SRC') {
  document.getElementById('main-logo').src = LOGO_SRC;
}

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let PRODUCTS = [];
let MESSAGES = [];
let CURRENT_PRODUCT = null;
let CURRENT_IMAGES = [];
let CURRENT_IMAGE_INDEX = 0;

/* ---------- Utils ---------- */
function rupiah(n){
  if (n==null) return '-';
  return 'Rp ' + Number(n).toLocaleString('id-ID');
}

function sanitizePhone(raw){
  if(!raw) return raw;
  const digits = raw.replace(/\D/g,'');
  if(digits.length === 0) return raw;
  if(digits.startsWith('0')) return '62' + digits.slice(1);
  if(digits.startsWith('62')) return digits;
  // assume local number -> prefix 62
  return '62' + digits;
}

async function tryFetch(table, select = '*') {
  try {
    const { data, error } = await supabase.from(table).select(select);
    if(error) {
      // try console but continue
      console.warn('Supabase select error table', table, error.message);
      return null;
    }
    return data;
  } catch(e){
    console.warn('Fetch fail', e);
    return null;
  }
}

/* ---------- Load data ---------- */
async function loadMessages(){
  let data = await tryFetch(TABLE_MESSAGES, 'wa_number');
  if(!data) {
    // try fallback plural
    data = await tryFetch(TABLE_MESSAGES + 's', 'wa_number');
  }
  MESSAGES = (data || []).map(r => r.wa_number).filter(Boolean);
  if(MESSAGES.length === 0) {
    // fallback placeholder numbers for testing
    MESSAGES = ['081234567890','081111111111','081222222222','081333333333'];
  }
}

async function loadProducts(){
  let data = await tryFetch(TABLE_PRODUCTS);
  if(!data) {
    // try english fallback
    data = await tryFetch('products');
  }
  PRODUCTS = (data || []).map(p => normalizeProduct(p));
  renderCategories();
  renderProducts(PRODUCTS);
  initHero(PRODUCTS);
}

/* Normalize incoming product object to stable shape */
function normalizeProduct(p){
  return {
    id: p.id ?? p._id ?? Math.random().toString(36).slice(2,9),
    name: p.name ?? p.nama ?? p.product_name ?? 'Produk',
    description: p.description ?? p.desc ?? p.deskripsi ?? '',
    price: p.price ?? p.harga ?? 0,
    images: Array.isArray(p.images) ? p.images : (p.images ? [p.images] : (p.image ? [p.image] : [])),
    merchant_name: p.merchant_name ?? p.merchant ?? p.nama_merchant ?? 'Merchant',
    merchant_address: p.merchant_address ?? p.address ?? p.alamat ?? '',
    category: p.category ?? p.kategori ?? 'Umum'
  };
}

/* ---------- Render UI ---------- */
const grid = document.getElementById('product-grid');

function renderProducts(list){
  grid.innerHTML = '';
  if(list.length === 0){
    grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12">Tidak ada produk</div>';
    return;
  }
  for(const p of list){
    const img = p.images[0] || 'https://via.placeholder.com/400x300?text=No+Image';
    const card = document.createElement('article');
    card.className = 'bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition cursor-pointer';
    card.innerHTML = `
      <div class="h-40 bg-gray-100 overflow-hidden">
        <img src="${img}" alt="${escapeHtml(p.name)}" class="w-full h-full object-cover"/>
      </div>
      <div class="p-3">
        <h3 class="font-semibold text-sm">${escapeHtml(p.name)}</h3>
        <p class="text-xs text-gray-500 mt-1">${escapeHtml(p.merchant_name)}</p>
        <div class="mt-3 flex items-center justify-between">
          <div class="text-sm font-medium text-brand-700">${rupiah(p.price)}</div>
          <button class="px-3 py-1 text-xs border rounded-md open-btn">Lihat</button>
        </div>
      </div>
    `;
    card.querySelector('.open-btn').addEventListener('click', (e)=>{
      e.stopPropagation();
      openProductModal(p);
    });
    card.addEventListener('click', ()=> openProductModal(p));
    grid.appendChild(card);
  }
}

/* categories */
function renderCategories(){
  const container = document.querySelector('header + section') || document.querySelector('header .max-w-7xl');
  const strip = document.querySelector('header .border-t .max-w-7xl div');
  // build unique categories
  const cats = ['Semua', ...Array.from(new Set(PRODUCTS.map(p=>p.category || 'Umum')))];
  const target = strip;
  target.innerHTML = '';
  cats.forEach(c=>{
    const btn = document.createElement('button');
    btn.className = 'category-chip px-3 py-1 rounded-full text-sm';
    btn.textContent = c;
    btn.addEventListener('click', ()=> {
      document.querySelectorAll('.category-chip').forEach(x=>x.classList.remove('bg-brand-500','text-white'));
      btn.classList.add('bg-brand-500','text-white');
      filterByCategory(c === 'Semua' ? null : c);
    });
    target.appendChild(btn);
  });
}

/* ---------- Modal handlers ---------- */
const modal = document.getElementById('product-modal');
const modalClose = document.getElementById('modal-close');
modalClose.addEventListener('click', ()=> modal.classList.add('hidden'));
modal.addEventListener('click', (e)=> { if(e.target === modal) modal.classList.add('hidden'); });

function openProductModal(p){
  CURRENT_PRODUCT = p;
  CURRENT_IMAGES = p.images.length ? p.images : ['https://via.placeholder.com/600x400?text=No+Image'];
  CURRENT_IMAGE_INDEX = 0;
  document.getElementById('modal-image').src = CURRENT_IMAGES[0];
  document.getElementById('modal-title').textContent = p.name;
  document.getElementById('modal-name').textContent = p.name;
  document.getElementById('modal-desc').textContent = p.description;
  document.getElementById('modal-price').textContent = rupiah(p.price);
  document.getElementById('modal-merchant').textContent = p.merchant_name + (p.merchant_address ? ' · ' + p.merchant_address : '');
  modal.classList.remove('hidden');
}

/* image next/prev inside modal */
document.getElementById('img-next').addEventListener('click', ()=> {
  if(!CURRENT_IMAGES.length) return;
  CURRENT_IMAGE_INDEX = (CURRENT_IMAGE_INDEX + 1) % CURRENT_IMAGES.length;
  document.getElementById('modal-image').src = CURRENT_IMAGES[CURRENT_IMAGE_INDEX];
});
document.getElementById('img-prev').addEventListener('click', ()=> {
  if(!CURRENT_IMAGES.length) return;
  CURRENT_IMAGE_INDEX = (CURRENT_IMAGE_INDEX - 1 + CURRENT_IMAGES.length) % CURRENT_IMAGES.length;
  document.getElementById('modal-image').src = CURRENT_IMAGES[CURRENT_IMAGE_INDEX];
});

/* Wishlist button (simple localStorage) */
document.getElementById('btn-wishlist-toggle').addEventListener('click', ()=> {
  const key = 'wishlist_ids_v1';
  const list = JSON.parse(localStorage.getItem(key) || '[]');
  const id = CURRENT_PRODUCT.id;
  if(list.includes(id)){
    const updated = list.filter(x=>x!==id);
    localStorage.setItem(key, JSON.stringify(updated));
    alert('Dihapus dari wishlist');
  } else {
    list.push(id);
    localStorage.setItem(key, JSON.stringify(list));
    alert('Ditambahkan ke wishlist');
  }
});

/* Open checkout form from product modal */
document.getElementById('btn-order').addEventListener('click', ()=> {
  modal.classList.add('hidden');
  openCheckoutModal(CURRENT_PRODUCT);
});

function openCheckoutModal(product){
  const modal = document.getElementById('checkout-modal');
  const form = document.getElementById('checkout-form');
  form.reset();
  form.dataset.productId = product.id;
  // quick fill for testing
  modal.classList.remove('hidden');
}
document.getElementById('checkout-close').addEventListener('click', ()=> document.getElementById('checkout-modal').classList.add('hidden'));
document.getElementById('checkout-modal').addEventListener('click', (e)=> { if(e.target === document.getElementById('checkout-modal')) document.getElementById('checkout-modal').classList.add('hidden'); });

/* ---------- Checkout submit -> WhatsApp rotation ---------- */
document.getElementById('checkout-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = {
    full_name: fd.get('full_name'),
    rt: fd.get('rt'),
    rw: fd.get('rw'),
    phone: fd.get('phone'),
    product: CURRENT_PRODUCT
  };
  // choose operator
  const op = chooseOperator();
  const opFormatted = sanitizePhone(op);
  // build message
  const lines = [
    `Nama: ${payload.full_name}`,
    `Alamat: RT ${payload.rt}/RW ${payload.rw}`,
    `Nomor HP: ${payload.phone}`,
    `Merchant: ${payload.product.merchant_name}`,
    `Produk: ${payload.product.name} (${rupiah(payload.product.price)})`,
    `Alamat Merchant: ${payload.product.merchant_address || '-'}`,
    `Catatan: -`
  ];
  const text = encodeURIComponent(lines.join('\n'));
  // open WhatsApp
  const waUrl = `https://wa.me/${opFormatted}?text=${text}`;
  // increment rotation counter persistently
  incrementRotationCounter();
  window.open(waUrl, '_blank');
  document.getElementById('checkout-modal').classList.add('hidden');
});

/* choose operator number with rotation logic */
function chooseOperator(){
  if(MESSAGES.length === 0) return '081234567890'; // fallback
  let idx = Number(localStorage.getItem('wa_rotation_index_v1') || 0);
  const number = MESSAGES[idx % MESSAGES.length];
  return number;
}
function incrementRotationCounter(){
  let idx = Number(localStorage.getItem('wa_rotation_index_v1') || 0);
  idx = (idx + 1) % (MESSAGES.length || 4);
  localStorage.setItem('wa_rotation_index_v1', String(idx));
}

/* ---------- Filters & Search ---------- */
document.getElementById('search').addEventListener('input', (e)=>{
  const v = e.target.value.trim().toLowerCase();
  document.getElementById('clear-search').classList.toggle('hidden', v.length===0);
  if(v.length === 0){
    renderProducts(PRODUCTS);
    return;
  }
  const filtered = PRODUCTS.filter(p=>{
    return (p.name||'').toLowerCase().includes(v) ||
           (p.description||'').toLowerCase().includes(v) ||
           (p.merchant_name||'').toLowerCase().includes(v) ||
           (p.category||'').toLowerCase().includes(v);
  });
  renderProducts(filtered);
});
document.getElementById('clear-search').addEventListener('click', ()=>{
  document.getElementById('search').value = '';
  document.getElementById('clear-search').classList.add('hidden');
  renderProducts(PRODUCTS);
});

function filterByCategory(cat){
  if(!cat) { renderProducts(PRODUCTS); return; }
  const filtered = PRODUCTS.filter(p => (p.category || 'Umum') === cat);
  renderProducts(filtered);
}

/* ---------- Hero slider simple ---------- */
let heroIndex = 0;
function initHero(list){
  const hero = document.getElementById('hero-content');
  const imgs = list.filter(Boolean).slice(0,5).map(p=>p.images[0] || '');
  if(imgs.length === 0) {
    hero.innerHTML = '<div><h2 class="text-2xl font-bold">Selamat datang</h2><p class="text-sm text-gray-600">Temukan makanan favoritmu</p></div>';
    return;
  }
  function show(i){
    const prod = list[i];
    hero.innerHTML = `
      <div class="w-full h-full flex items-center gap-6">
        <img src="${prod.images[0]||'https://via.placeholder.com/300x200?text=No+Image'}" class="h-36 w-48 object-cover rounded-md shadow"/>
        <div class="text-left">
          <h3 class="text-xl font-bold">${escapeHtml(prod.merchant_name)}</h3>
          <p class="text-sm text-gray-600">${escapeHtml(prod.name)} · ${rupiah(prod.price)}</p>
        </div>
      </div>
    `;
  }
  show(0);
  document.getElementById('hero-next').addEventListener('click', ()=> {
    heroIndex = (heroIndex + 1) % list.length;
    show(heroIndex);
  });
  document.getElementById('hero-prev').addEventListener('click', ()=> {
    heroIndex = (heroIndex - 1 + list.length) % list.length;
    show(heroIndex);
  });
}

/* ---------- Init ---------- */
async function init(){
  await loadMessages();
  await loadProducts();
}
init();

/* ---------- Small helpers ---------- */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
</script>
</body>
</html>
